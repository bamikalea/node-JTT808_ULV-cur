#!/bin/bash

# Vultr Server Update Script
# This script updates the Vultr server with the latest code changes

echo "üöÄ Vultr Server Update Script"
echo "============================="
echo ""

# Check if VULTR_IP is provided
if [ -z "$1" ]; then
    echo "‚ùå Error: Vultr server IP address required!"
    echo ""
    echo "Usage: ./update-vultr-server.sh YOUR_VULTR_IP"
    echo "Example: ./update-vultr-server.sh 123.456.789.012"
    echo ""
    echo "üîç To find your Vultr IP:"
    echo "   ‚Ä¢ Check your Vultr dashboard"
    echo "   ‚Ä¢ Look for the server's public IP address"
    echo ""
    exit 1
fi

VULTR_IP="$1"
echo "üì± Updating Vultr server at: $VULTR_IP"
echo ""

echo "üìã Update Summary:"
echo "=================="
echo "‚úÖ ULV Message Routing Fix: 0x900 ‚Üí handleDeviceDataReport"
echo "‚úÖ Restart Command Parsing: Proper 0x74 detection"
echo "‚úÖ Device ID Fix: 098765432109 properly recognized"
echo "‚úÖ Leading Zero Preservation: All device IDs maintained"
echo "‚úÖ Enhanced ULV Protocol Support"
echo ""

echo "üöÄ Starting Vultr Server Update..."
echo "================================="
echo ""

# Step 1: SSH into Vultr server
echo "1Ô∏è‚É£ Connecting to Vultr server..."
echo "   SSH: root@$VULTR_IP"
echo ""

# Step 2: Update commands
echo "2Ô∏è‚É£ Commands to run on Vultr server:"
echo "===================================="
echo ""
echo "# Navigate to project directory"
echo "cd /root/node-JTT808_ULV-cur"
echo ""
echo "# Stop the current server"
echo "pm2 stop jt808-server"
echo ""
echo "# Pull latest code from GitHub"
echo "git pull origin main"
echo ""
echo "# Install dependencies (if needed)"
echo "npm install"
echo ""
echo "# Start the updated server"
echo "pm2 start jt808-server"
echo ""
echo "# Check server status"
echo "pm2 status"
echo ""
echo "# Monitor server logs"
echo "pm2 logs jt808-server"
echo ""

# Step 3: Verification steps
echo "3Ô∏è‚É£ Verification Steps:"
echo "======================"
echo ""
echo "‚úÖ Check if server is running:"
echo "   pm2 status"
echo ""
echo "‚úÖ Check server logs:"
echo "   pm2 logs jt808-server"
echo ""
echo "‚úÖ Test restart command:"
echo "   Send ULV restart command (0x74) to server"
echo "   Monitor logs for proper ULV message parsing"
echo ""
echo "‚úÖ Verify device ID support:"
echo "   Check if 098765432109 is recognized"
echo ""

# Step 4: SSH connection command
echo "4Ô∏è‚É£ Connect to Vultr Server:"
echo "============================"
echo ""
echo "üîó SSH Command:"
echo "ssh root@$VULTR_IP"
echo ""
echo "üìÅ Project Directory:"
echo "cd /root/node-JTT808_ULV-cur"
echo ""

# Step 5: Quick update commands
echo "5Ô∏è‚É£ Quick Update Commands (copy & paste):"
echo "========================================="
echo ""
echo "pm2 stop jt808-server && git pull origin main && npm install && pm2 start jt808-server && pm2 status"
echo ""

echo "üéØ Ready to update Vultr server!"
echo "================================="
echo ""
echo "üì± Next steps:"
echo "   1. SSH into your Vultr server"
echo "   2. Run the update commands above"
echo "   3. Verify the server is running"
echo "   4. Test the ULV restart command"
echo "   5. Check device ID recognition"
echo ""
echo "üöÄ The updated server will have:"
echo "   ‚Ä¢ Fixed ULV message routing"
echo "   ‚Ä¢ Working restart commands"
echo "   ‚Ä¢ Proper device ID handling"
echo "   ‚Ä¢ Enhanced ULV protocol support"
echo ""
echo "Need help with any step? Let me know!"
echo "====================================="
